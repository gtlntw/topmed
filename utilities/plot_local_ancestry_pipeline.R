#example: Rscript /net/wonderland/home/gzajac/gfg/plot_viterbi_pipeline_version.R $iid ${output_path}/${iid}/${iid}_local_ancestry_plot.png \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr1.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr1.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr2.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr2.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr3.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr3.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr4.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr4.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr5.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr5.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr6.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr6.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr7.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr7.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr8.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr8.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr9.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr9.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr10.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr10.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr11.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr11.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr12.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr12.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr13.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr13.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr14.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr14.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr15.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr15.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr16.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr16.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr17.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr17.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr18.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr18.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr19.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr19.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr20.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr20.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr21.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr21.txt \
#	${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_outputPopPhased_chr22.0.Viterbi.txt ${output_path}/${iid}/misc/HGDP_938_imputed_${iid}_filtered_phased_site_list_chr22.txt \
#	40000
# courtesy of Gregory Zajac
# modified by Keng-Han lin
# 2015-08-31 modified the legeng to show only subset

#library(quantsmooth, lib.loc = "/net/frodo//home/khlin/R/x86_64-pc-linux-gnu-library/3.2") 
#source("http://bioconductor.org/biocLite.R")
#biocLite("quantsmooth")
library("quantsmooth")


prepareGenomePlot_modified = function (chrompos = NULL, cols = "grey50", paintCytobands = FALSE, 
    bleach = 0, topspace = 1, organism, sexChromosomes = FALSE, 
    units = "hg19", ...) 
{
    cytobandWidth <- 0.075
    par(mar = c(1, 15, 21, 10) + 0.1, cex.axis = 7, ylbias = 5)
    if (!missing(organism)) {
        organism <- match.arg(organism, c("hsa", "mmu", "rno"))
        chrom.n <- switch(organism, hsa = 22, mmu = 19, rno = 20)
        if (is.null(chrompos)) {
            chroms = c(1:chrom.n, if (sexChromosomes) c(98, 99) else NULL)
            chrnames = characterCHR(chroms, "chr")
            mapinfo = rep(0, length(chroms))
            chrompos = cbind(CHR = chroms, MapInfo = mapinfo)
            rownames(chrompos) <- chrnames
        }
        chrs2 <- factor(numericCHR(chrompos[, "CHR"]), levels = c(1:chrom.n, 
            if (sexChromosomes) c(98, 99) else NULL))
        if (organism == "hsa") 
            lens <- lengthChromosome(levels(chrs2), units = units)
        else lens <- sapply(split(chrompos[, "MapInfo"], chrs2), 
            function(x) max(c(0, x)))
        names(lens) <- characterCHR(names(lens))
        cols <- rep(cols, length.out = length(lens))
        names(cols) <- names(lens)
        dwidth <- NULL
        for (i in 1:(chrom.n%/%2)) dwidth[i] <- lens[i] + lens[chrom.n + 
            1 - i]
        if (chrom.n%%2 == 1) 
            dwidth <- c(dwidth, lens[chrom.n%/%2 + 1])
        if (sexChromosomes) 
            dwidth <- c(dwidth, lens["X"] + lens["Y"])
        maxdwidth <- max(dwidth) * 1.05
        leftrow <- c(if (sexChromosomes) "X" else NULL, ((chrom.n + 
            1)%/%2):1)
        rightrow <- c(if (sexChromosomes) "Y" else NULL, if (chrom.n%%2 == 
            1) "" else NULL, ((chrom.n + 1)%/%2 + 1):chrom.n)
        plot(c(0, maxdwidth), c(0.5, 0.5 + length(dwidth) + topspace), 
            type = "n", ylab = "Chromosome", xlab = "", axes = FALSE, 
            las = 2, ...)
        axis(2, c(1:length(dwidth)), characterCHR(leftrow), las = 2, lwd = 4, lwd.ticks = 4)
        axis(4, c(1:length(dwidth)), characterCHR(rightrow), las = 2, lwd = 4, lwd.ticks = 4)
        if (paintCytobands && organism == "hsa") {
            for (i in 1:length(dwidth)) {
                if (lens[leftrow[i]] > 0) 
                  paintCytobands(leftrow[i], c(0, i + cytobandWidth/2), 
                    units, width = cytobandWidth, length.out = lens[leftrow[i]], 
                    legend = FALSE, bleach = bleach)
                if (rightrow[i] != "" && lens[rightrow[i]] > 
                  0) 
                  paintCytobands(rightrow[i], c(maxdwidth - lens[rightrow[i]], 
                    i + cytobandWidth/2), "bases", width = cytobandWidth, 
                    length.out = lens[rightrow[i]], legend = FALSE, 
                    bleach = bleach)
            }
        }
        else {
            for (i in 1:length(dwidth)) {
                lines(c(0, lens[leftrow[i]]), c(i, i), col = cols[leftrow[i]], 
                  lwd = 2)
                if (rightrow[i] != "") 
                  lines(c(maxdwidth - lens[rightrow[i]], maxdwidth), 
                    c(i, i), col = cols[rightrow[i]], lwd = 2)
            }
        }
        dchrompos <- matrix(0, nrow = nrow(chrompos), ncol = 2, 
            dimnames = list(rownames(chrompos), c("CHR", "MapInfo")))
        for (i in 1:length(rightrow)) if (rightrow[i] != "") {
            probes <- characterCHR(chrompos[, "CHR"]) == rightrow[i]
            dchrompos[probes, 2] <- chrompos[probes, "MapInfo"] + 
                maxdwidth - lens[rightrow[i]]
            dchrompos[probes, 1] <- i
        }
        for (i in 1:length(leftrow)) {
            probes <- characterCHR(chrompos[, "CHR"]) == leftrow[i]
            dchrompos[probes, 2] <- chrompos[probes, "MapInfo"]
            dchrompos[probes, 1] <- i
        }
    }
    else {
        chrs2 <- factor(numericCHR(chrompos[, "CHR"]))
        lens <- sapply(split(chrompos[, "MapInfo"], chrs2), max)
        m <- length(lens)
        cols <- rep(cols, length.out = m)
        maxdwidth <- max(lens)
        plot(c(0, maxdwidth), c(0.5, m + 0.5 + topspace), type = "n", 
            ylab = "Chromosome", xlab = "", axes = FALSE, las = 2, 
            ...)
        axis(2, c(m:1), characterCHR(names(lens)), las = 2)
        for (i in 1:m) lines(c(0, lens[i]), c(m + 1 - i, m + 
            1 - i), col = cols[as.numeric(names(lens))], lwd = 2)
        dchrompos <- chrompos
        dchrompos[, 1] <- m + 1 - as.numeric(chrs2)
    }
    dchrompos
}

argv <- commandArgs(TRUE)

id = argv[1]
output_file = argv[2]
n = length(argv)
indeces = (2:((n-1)/2))*2 - 1
#viterbi_file = argv[1]
#site_list_file = argv[2]
block_length = as.numeric(argv[n])

id_list = id
id_list$IID = id
id_columns = as.vector(rbind(paste0(id_list$IID, "_H1"), paste0(id_list$IID, "_H2")))

#color_array = c("red", "darkgreen", "green", "blue", "lightgreen", "lightgreen", "darkblue")
color_array = c("#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2")
#color_array = rainbow(7)

read_files = function(i) {
	site_list = read.table(argv[i+1], header=F, stringsAsFactors=F, col.names = c("CHR", "POS"))
	viterbi = read.table(argv[i], header=F, stringsAsFactors=F, col.names = id_columns, check.names=F)
	
	viterbi_sites = cbind(viterbi, site_list)
	viterbi_sites
}

viterbi_sites = lapply(indeces, read_files)
invisible(ifelse(grepl("HGDP_subset|1000g_subset", id), ancestry_idx <-c(1,4,5), ancestry_idx <- 1:7)) #if only using HGDP_subset, then set legend to subset  
#if subset_global then change to individual ref label
invisible(if(grepl("global", id)) {
  id_temp <- substr(id, 1, 9)
  ref <- read.table(paste0("/net/topmed2/working/khlin/global_ancestry/temp/",id_temp,"/",id_temp,"_HGDP_ref.txt"), header = F)$V1
  ancestry_idx <- ref #if only using HGDP_subset, then set legend to subset  
})

plot_one_chrom = function(i, id, chrompos){
	rect(chrompos[viterbi_sites[[i]][,"CHR"],2] + viterbi_sites[[i]][,"POS"], chrompos[viterbi_sites[[i]][,"CHR"],1], chrompos[viterbi_sites[[i]][,"CHR"],2] + viterbi_sites[[i]][,"POS"] + block_length, chrompos[viterbi_sites[[i]][,"CHR"],1] + 0.35,col=color_array[viterbi_sites[[i]][,paste0(id, "_H1")]],border=NA)
	rect(chrompos[viterbi_sites[[i]][,"CHR"],2] + viterbi_sites[[i]][,"POS"], chrompos[viterbi_sites[[i]][,"CHR"],1], chrompos[viterbi_sites[[i]][,"CHR"],2] + viterbi_sites[[i]][,"POS"] + block_length, chrompos[viterbi_sites[[i]][,"CHR"],1] + -0.35,col=color_array[viterbi_sites[[i]][,paste0(id, "_H2")]],border=NA)
}

plot_chromosomes = function(id) {
	png(output_file, height = 3000, width = 4000)
	#chrompos <- prepareGenomePlot(paintCytobands = F, organism="hsa",units="bases", sexChromosomes=F, main = id, cex.main = 10, cex.lab=10, cex.axis = 8)
	chrompos <- prepareGenomePlot_modified(paintCytobands = F, organism="hsa",units="bases", sexChromosomes=F, main = id, cex.main = 7, cex.lab=7)
	legend("top", legend = c("Africa", "Central and S. Asia", "Eastern Asia", "Europe", "Native America", "Oceania", "W. Asia and N. Africa")[ancestry_idx] , col = color_array[ancestry_idx], pch = 15, ncol = 3, bty="n", cex = 5)
	lapply(1:((n-1)/2-1), plot_one_chrom, id, chrompos)
	dev.off()
}

lapply(id_list$IID, plot_chromosomes)

